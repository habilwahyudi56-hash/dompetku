<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DompetKu Pro - HABIIL_QW</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* --- RESET CSS & LAYOUT FIXES --- */
    * {
      box-sizing: border-box; /* Kunci agar padding tidak bikin lebar */
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --bg-app: #f0f4f8;
      --card-bg: #ffffff;
      --text-dark: #1e293b;
      --text-muted: #64748b;
      --primary-grad: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      --shadow-soft: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
      --radius-xl: 24px;
      --radius-md: 16px;
    }

    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden; /* Mencegah geser kanan-kiri */
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-app);
      color: var(--text-dark);
      position: relative;
    }

    /* --- UTILITIES --- */
    .hidden { display: none !important; }

    /* KONTAINER UTAMA (JARAK AMAN) */
    .container {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      /* Padding Kiri Kanan WAJIB ada */
      padding: 20px 20px 100px 20px;
      display: flex;
      flex-direction: column;
    }

    /* --- COMPONENTS --- */
    
    /* Input & Select */
    input, select {
      width: 100%; /* Penuhi lebar form */
      padding: 14px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      background: #f8fafc;
      font-family: inherit;
      font-size: 14px;
      transition: 0.3s;
    }
    input:focus, select:focus { outline: none; border-color: #8b5cf6; background: #fff; }

    /* Buttons */
    button.btn-primary {
      width: 100%;
      padding: 15px;
      background: var(--primary-grad);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: 0.3s;
      display: flex; justify-content: center; align-items: center; gap: 8px;
    }
    button.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }

    /* Loading Screen */
    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: var(--bg-app); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .loading-logo {
      width: 100px; height: 100px; border-radius: 50%; overflow: hidden;
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.3); animation: pulseLogo 2s infinite ease-in-out;
    }
    .loading-logo img { width: 100%; height: 100%; object-fit: cover; }
    @keyframes pulseLogo {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(139, 92, 246, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
    }

    /* PIN Screen */
    #pin-screen {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: var(--bg-app); z-index: 9990;
      display: flex; justify-content: center; align-items: center; padding: 20px;
    }
    .pin-box {
      background: #fff; padding: 40px 30px; border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft); text-align: center; width: 100%; max-width: 400px;
    }
    .pin-logo {
      width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 20px;
      overflow: hidden; border: 3px solid #8b5cf6;
    }
    .pin-logo img { width: 100%; height: 100%; object-fit: cover; }
    #pinError { color: #e11d48; margin-bottom: 15px; font-size: 14px; display: none; }
    .shake { animation: shake 0.5s; }
    @keyframes shake { 
      0%, 100% { transform: translateX(0); } 
      25%, 75% { transform: translateX(-10px); } 
      50% { transform: translateX(10px); } 
    }

    /* Header */
    .header-section {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 30px; background: #fff; padding: 15px 25px;
      border-radius: var(--radius-xl); box-shadow: var(--shadow-soft);
      gap: 15px; width: 100%;
    }
    .profile-container { display: flex; align-items: center; gap: 15px; }
    .profile-logo-small {
      width: 50px; height: 50px; border-radius: 50%; border: 2px solid #8b5cf6;
      overflow: hidden; flex-shrink: 0;
    }
    .profile-logo-small img { width: 100%; height: 100%; object-fit: cover; }
    .profile-name { font-weight: 700; font-size: 1.2rem; color: var(--text-dark); }
    
    .app-title-container { text-align: right; }
    .app-title-container h1 {
      margin: 0; font-size: 1.2rem;
      background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .status-indicator {
      font-size: 11px; color: #64748b; margin-top: 5px;
      display: flex; align-items: center; gap: 5px; justify-content: flex-end;
    }
    .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
    .status-online { background: #10b981; box-shadow: 0 0 10px #10b981; }

    /* --- LAYOUT GRID --- */
    /* Jurus 1: min-width: 0 pada item grid mencegah overflow */
    .summary-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px; margin-bottom: 30px; width: 100%;
    }
    .card-hero {
      background: var(--card-bg); padding: 25px; border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft); position: relative; overflow: hidden;
      min-width: 0; /* PENTING */
    }
    .card-icon-bg {
      position: absolute; top: -10px; right: -10px; font-size: 90px;
      opacity: 0.05; transform: rotate(15deg);
    }
    .card-hero h3 { margin: 0; font-size: 13px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
    .card-hero p.amount { margin: 10px 0 0; font-size: 26px; font-weight: 700; word-wrap: break-word; }
    .card-balance .amount { background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .card-in .amount { color: #10b981; }
    .card-out .amount { color: #f43f5e; }

    .main-content-grid {
      display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; margin-bottom: 30px; width: 100%;
    }
    .content-box {
      background: var(--card-bg); padding: 25px; border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft); position: relative; margin-bottom: 25px;
      width: 100%; min-width: 0; /* PENTING */
    }
    .section-title {
      margin-top: 0; margin-bottom: 20px; font-size: 1.1rem; font-weight: 600;
      display: flex; align-items: center; gap: 10px;
    }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 13px; }

    /* Chart Area */
    .chart-wrapper {
        position: relative; 
        height: 250px; 
        width: 100%; 
        overflow: hidden; /* Mencegah chart meluber */
    }

    /* Table */
    table { width: 100%; border-collapse: separate; border-spacing: 0 10px; margin-top: -10px; }
    th { text-align: left; color: var(--text-muted); font-size: 12px; padding: 0 15px; text-transform: uppercase; white-space: nowrap; }
    tbody tr { background: #fff; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02); transition: 0.2s; }
    td { padding: 15px; border: none; font-size: 14px; vertical-align: middle; }
    td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
    td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; text-align: right; }
    
    .badge-modern { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap; }
    .badge-in { background: #ecfdf5; color: #059669; }
    .badge-out { background: #fff1f2; color: #e11d48; }
    .btn-delete-icon { background: #fee2e2; color: #ef4444; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
    
    .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: none; justify-content: center; align-items: center; z-index: 10; border-radius: var(--radius-xl); font-weight: 600; color: #6366f1; }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; width: 100%; background: #fff;
      display: flex; justify-content: space-around; padding: 15px 10px;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05); z-index: 100;
      border-top-left-radius: 20px; border-top-right-radius: 20px;
      padding-bottom: calc(15px + env(safe-area-inset-bottom));
    }
    .nav-item { text-align: center; color: var(--text-muted); cursor: pointer; transition: 0.3s; flex: 1; }
    .nav-item i { font-size: 20px; margin-bottom: 5px; display: block; }
    .nav-item span { font-size: 12px; font-weight: 500; }
    .nav-item.active { color: #8b5cf6; }

    /* Reports */
    .report-filters { display: flex; gap: 15px; margin-bottom: 25px; }
    .report-result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    .report-card { background: #f8fafc; padding: 20px; border-radius: 15px; text-align: center; border: 1px solid #e2e8f0; min-width: 0;}
    .report-card h4 { margin: 0 0 10px 0; font-size: 14px; color: var(--text-muted); }
    .report-card p { margin: 0; font-size: 20px; font-weight: 700; word-wrap: break-word; }

    /* ============ MEDIA QUERIES (MOBILE FIXES) ============ */
    
    @media (max-width: 900px) {
      .main-content-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 480px) {
      /* Padding yang aman untuk HP */
      .container { 
        padding: 15px 15px 100px 15px !important;
        width: 100vw;
        max-width: 100vw; 
      }

      .header-section { 
        padding: 12px 15px; 
        flex-direction: row; 
        justify-content: space-between;
      }

      /* Kecilkan elemen header */
      .profile-logo-small { width: 35px; height: 35px; }
      .profile-name { font-size: 0.9rem; display: block !important; }
      .app-title-container h1 { font-size: 1rem; }
      .profile-container { gap: 8px; }

      /* Paksa 1 kolom */
      .summary-grid { grid-template-columns: 1fr; }
      .report-filters { flex-direction: column; }
      .report-result-grid { grid-template-columns: 1fr; }
      
      /* Hapus margin negatif tabel agar tidak nabrak di HP */
      table { margin-top: 0; }
    }
  </style>
</head>

<body>

  <div id="loading-screen">
    <div class="loading-logo">
      <img src="logo.png" alt="Logo" onerror="this.src='HOREG LOGO.png'">
    </div>
    <h2 style="margin-top: 20px; font-size: 1.2rem; color: var(--text-dark);">Memuat Aplikasi...</h2>
  </div>

  <div id="pin-screen" class="hidden">
    <div class="pin-box" id="pinBox">
      <div class="pin-logo">
        <img src="logo.png" alt="Logo" onerror="this.src='HOREG LOGO.png'">
      </div>
      <h3>Masukkan PIN Keamanan</h3>
      <p style="color:var(--text-muted); font-size:13px; margin-bottom:25px;">Akses HABIIL_QW Protected</p>
      <form id="pinForm">
        <div class="form-group">
          <input type="password" id="pinInput" placeholder="Masukkan PIN Anda"
            style="text-align: center; letter-spacing: 5px; font-size: 18px;" maxlength="8" required>
        </div>
        <div id="pinError"><i class="fa-solid fa-circle-exclamation"></i> PIN Salah!</div>
        <button type="submit" class="btn-primary">Masuk Aplikasi <i class="fa-solid fa-arrow-right"></i></button>
      </form>
    </div>
  </div>

  <div id="main-app" class="hidden">
    <div class="container">
      
      <div class="header-section">
        <div class="profile-container">
          <div class="profile-logo-small">
            <img src="logo.png" alt="Logo" onerror="this.src='HOREG LOGO.png'">
          </div>
          <div class="profile-name">HABIIL_QW</div>
        </div>
        <div class="app-title-container">
          <h1>DompetKu</h1>
          <div class="status-indicator">
            <div id="statusDot" class="status-dot"></div>
            <span id="statusText">Koneksi...</span>
          </div>
        </div>
      </div>

      <div id="dashboard-view">
        <div class="summary-grid">
          <div class="card-hero card-balance">
            <i class="fa-solid fa-scale-balanced card-icon-bg"></i>
            <h3>Sisa Saldo Total</h3>
            <p class="amount" id="displayBalance">Rp 0</p>
          </div>
          <div class="card-hero card-in">
            <i class="fa-solid fa-arrow-trend-up card-icon-bg"></i>
            <h3>Total Pemasukan</h3>
            <p class="amount" id="displayIn">Rp 0</p>
          </div>
          <div class="card-hero card-out">
            <i class="fa-solid fa-arrow-trend-down card-icon-bg"></i>
            <h3>Total Pengeluaran</h3>
            <p class="amount" id="displayOut">Rp 0</p>
          </div>
        </div>

        <div class="main-content-grid">
          <div class="content-box">
            <div id="formLoader" class="loading-overlay">Menyimpan...</div>
            <h3 class="section-title"><i class="fa-solid fa-circle-plus" style="color: #8b5cf6;"></i> Transaksi Baru</h3>
            <form id="transactionForm">
              <div class="form-group">
                <label>Deskripsi</label>
                <input type="text" id="desc" placeholder="Contoh: Gaji, Makan Siang..." required>
              </div>
              <div class="form-group">
                <label>Nominal (Rp)</label>
                <input type="number" id="amount" placeholder="0" min="1" required>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                  <label>Tipe</label>
                  <select id="type">
                    <option value="in">Masuk (+)</option>
                    <option value="out">Keluar (-)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Tanggal</label>
                  <input type="date" id="date" required>
                </div>
              </div>
              <button type="submit" class="btn-primary"><i class="fa-solid fa-cloud-arrow-up"></i> Simpan ke Cloud</button>
            </form>
          </div>
          
          <div class="content-box">
            <h3 class="section-title"><i class="fa-solid fa-chart-pie" style="color: #8b5cf6;"></i> Grafik Total</h3>
            <div class="chart-wrapper">
              <canvas id="financeChart"></canvas>
            </div>
          </div>
        </div>

        <div class="content-box">
          <div id="listLoader" class="loading-overlay" style="display: flex;">Memuat Data...</div>
          <h3 class="section-title"><i class="fa-solid fa-clock-rotate-left" style="color: #8b5cf6;"></i> Riwayat Terakhir</h3>
          <div style="overflow-x: auto;">
            <table>
              <tbody id="transactionList"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="report-view" class="hidden">
        <div class="content-box">
          <h3 class="section-title"><i class="fa-solid fa-file-invoice-dollar" style="color: #8b5cf6;"></i> Filter Laporan</h3>
          <div class="report-filters">
            <div style="flex: 1;">
              <label>Bulan</label>
              <select id="reportMonth">
                <option value="0">Semua Bulan</option>
                <option value="1">Januari</option>
                <option value="2">Februari</option>
                <option value="3">Maret</option>
                <option value="4">April</option>
                <option value="5">Mei</option>
                <option value="6">Juni</option>
                <option value="7">Juli</option>
                <option value="8">Agustus</option>
                <option value="9">September</option>
                <option value="10">Oktober</option>
                <option value="11">November</option>
                <option value="12">Desember</option>
              </select>
            </div>
            <div style="flex: 1;">
              <label>Tahun</label>
              <select id="reportYear">
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
              </select>
            </div>
          </div>
          <button class="btn-primary" onclick="generateReport()"><i class="fa-solid fa-filter"></i> Tampilkan Laporan</button>

          <div class="report-result-grid">
            <div class="report-card" style="border-color: #10b981; background: #ecfdf5;">
              <h4>Total Pemasukan (Periode Ini)</h4>
              <p style="color: #059669;" id="reportIn">Rp 0</p>
            </div>
            <div class="report-card" style="border-color: #f43f5e; background: #fff1f2;">
              <h4>Total Pengeluaran (Periode Ini)</h4>
              <p style="color: #e11d48;" id="reportOut">Rp 0</p>
            </div>
          </div>
          <div class="report-card" style="margin-top: 20px; border-color: #8b5cf6; background: #f5f3ff;">
            <h4>Surplus / Defisit (Periode Ini)</h4>
            <p style="color: #6366f1;" id="reportNet">Rp 0</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bottom-nav">
      <div class="nav-item active" onclick="switchView('dashboard')">
        <i class="fa-solid fa-house-chimney"></i>
        <span>Dashboard</span>
      </div>
      <div class="nav-item" onclick="switchView('report')">
        <i class="fa-solid fa-chart-simple"></i>
        <span>Laporan</span>
      </div>
    </div>
  </div>

  <script>
    // --- KONFIGURASI SUPABASE ---
    const SUPABASE_URL = 'https://qaklcjsawdpkbuzwuvkw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFha2xjanNhd2Rwa2J1end1dmt3Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzQwNjc5NSwiZXhwIjoyMDgyOTgyNzk1fQ._ujmh6wTn29qJcyuAJ98TpkFZEgd6l7fU2rm4U16Ypw';
    const CORRECT_PIN = "09022009";

    const { createClient } = supabase;
    const client = createClient(SUPABASE_URL, SUPABASE_KEY);
    let transactions = []; let myChart;
    const formatRupiah = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);

    // --- LOGIC START ---
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('loading-screen').classList.add('hidden');
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
          showMainApp();
        } else {
          document.getElementById('pin-screen').classList.remove('hidden');
        }
      }, 2500);
    });

    document.getElementById('pinForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const pinInput = document.getElementById('pinInput');
      const pinError = document.getElementById('pinError');
      const pinBox = document.getElementById('pinBox');

      if (pinInput.value === CORRECT_PIN) {
        sessionStorage.setItem('isLoggedIn', 'true');
        showMainApp();
      } else {
        pinError.style.display = 'block';
        pinBox.classList.add('shake');
        setTimeout(() => pinBox.classList.remove('shake'), 500);
        pinInput.value = '';
      }
    });

    function showMainApp() {
      document.getElementById('pin-screen').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');
      const today = new Date();
      document.getElementById('reportMonth').value = today.getMonth() + 1;
      document.getElementById('reportYear').value = today.getFullYear();
      checkConnection();
      fetchTransactions();
    }

    function switchView(viewName) {
      const dashView = document.getElementById('dashboard-view');
      const reportView = document.getElementById('report-view');
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => item.classList.remove('active'));

      if (viewName === 'dashboard') {
        dashView.classList.remove('hidden');
        reportView.classList.add('hidden');
        navItems[0].classList.add('active');
      } else {
        dashView.classList.add('hidden');
        reportView.classList.remove('hidden');
        navItems[1].classList.add('active');
        generateReport();
      }
    }

    async function checkConnection() {
      const { data, error } = await client.from('transactions').select('count', { count: 'exact', head: true });
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      if (!error) { dot.classList.add('status-online'); text.innerText = "Terhubung"; }
      else { console.error(error); text.innerText = "Gagal Konek"; text.style.color = 'red'; }
    }

    async function fetchTransactions() {
      document.getElementById('listLoader').style.display = 'flex';
      const { data, error } = await client.from('transactions').select('*').order('transaction_date', { ascending: false });
      if (!error) { transactions = data; updateDashboardUI(); }
      document.getElementById('listLoader').style.display = 'none';
    }

    document.getElementById('transactionForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const desc = document.getElementById('desc').value; const amount = document.getElementById('amount').value;
      const type = document.getElementById('type').value; const date = document.getElementById('date').value;
      document.getElementById('formLoader').style.display = 'flex';
      const { error } = await client.from('transactions').insert([{ description: desc, amount: amount, type: type, transaction_date: date }]);
      if (error) { alert('Gagal: ' + error.message); }
      else { this.reset(); document.getElementById('date').valueAsDate = new Date(); fetchTransactions(); }
      document.getElementById('formLoader').style.display = 'none';
    });

    async function deleteTransaction(id) {
      if (confirm('Hapus data ini?')) {
        document.getElementById('listLoader').style.display = 'flex';
        const { error } = await client.from('transactions').delete().eq('id', id);
        if (!error) fetchTransactions();
      }
    }

    function updateDashboardUI() {
      const list = document.getElementById('transactionList'); list.innerHTML = '';
      let bal = 0, inc = 0, exp = 0;
      transactions.slice(0, 20).forEach((t) => {
        let amt = Number(t.amount);
        const row = document.createElement('tr');
        row.innerHTML = `<td><span style="color:#64748b; font-size:12px;">${t.transaction_date}</span><br><strong>${t.description}</strong></td>
                <td><span class="badge-modern ${t.type === 'in' ? 'badge-in' : 'badge-out'}">${t.type === 'in' ? 'Masuk' : 'Keluar'}</span></td>
                <td style="text-align:right; color:${t.type === 'in' ? '#059669' : '#e11d48'}; font-weight:700;">${t.type === 'in' ? '+' : '-'} ${formatRupiah(amt)}</td>
                <td><button class="btn-delete-icon" onclick="deleteTransaction(${t.id})"><i class="fa-solid fa-xmark"></i></button></td>`;
        list.appendChild(row);
      });
      transactions.forEach(t => { let amt = Number(t.amount); if (t.type === 'in') { bal += amt; inc += amt; } else { bal -= amt; exp += amt; } });
      document.getElementById('displayBalance').innerText = formatRupiah(bal);
      document.getElementById('displayIn').innerText = formatRupiah(inc);
      document.getElementById('displayOut').innerText = formatRupiah(exp);
      updateChart(inc, exp);
    }

    function updateChart(inc, exp) {
      const ctx = document.getElementById('financeChart').getContext('2d');
      if (myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['Masuk', 'Keluar'], datasets: [{ data: [inc, exp], backgroundColor: ['#10b981', '#f43f5e'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom' } } }
      });
    }

    function generateReport() {
      const selectedMonth = parseInt(document.getElementById('reportMonth').value);
      const selectedYear = parseInt(document.getElementById('reportYear').value);
      let reportIn = 0; let reportOut = 0;

      const filteredTransactions = transactions.filter(t => {
        const tDate = new Date(t.transaction_date);
        const matchYear = tDate.getFullYear() === selectedYear;
        const matchMonth = selectedMonth === 0 ? true : (tDate.getMonth() + 1) === selectedMonth;
        return matchYear && matchMonth;
      });

      filteredTransactions.forEach(t => {
        if (t.type === 'in') reportIn += Number(t.amount);
        else reportOut += Number(t.amount);
      });

      document.getElementById('reportIn').innerText = formatRupiah(reportIn);
      document.getElementById('reportOut').innerText = formatRupiah(reportOut);
      const net = reportIn - reportOut;
      const netEl = document.getElementById('reportNet');
      netEl.innerText = (net >= 0 ? '+ ' : '- ') + formatRupiah(Math.abs(net));
      netEl.style.color = net >= 0 ? '#6366f1' : '#e11d48';
    }

    document.getElementById('date').valueAsDate = new Date();
  </script>

</body>
</html>
